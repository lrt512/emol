services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "8000:80"
    healthcheck:
      test: ["CMD", "/etc/init.d/emol", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      - EMOL_DEV=1
      - AWS_DEFAULT_REGION=ca-central-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - SSM_ENDPOINT_URL=http://localstack:4566
      - DJANGO_SETTINGS_MODULE=emol.settings.dev
    volumes:
      - .:/opt/emol
      - static:/opt/emol/static
      - emol_logs:/var/log/emol
      - nginx_logs:/var/log/nginx
      - nginx_run:/run/nginx
      # Mount configuration files from local config/ directory (optional)
      # Mirrors production /opt/emol_config structure
      # - ./config/emol_production.py:/opt/emol/emol/emol/settings/emol_production.py:ro
      # - ./config/emol_credentials.json:/opt/emol/emol_credentials.json:ro
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    networks:
      - emol-network

  localstack:
    image: localstack/localstack
    environment:
      - SERVICES=ssm
      - DEBUG=1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=ca-central-1
    ports:
      - "4566:4566"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - ./setup_files/localstack/init:/etc/localstack/init/ready.d/
    networks:
      - emol-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  db:
    image: mysql:latest
    environment:
      - MYSQL_DATABASE=emol
      - MYSQL_USER=emol_db_user
      - MYSQL_PASSWORD=emol_db_password
      - MYSQL_ROOT_PASSWORD=root_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./setup_files/mysql/init:/docker-entrypoint-initdb.d/
    networks:
      - emol-network
    healthcheck:
      test: ["CMD", "mysql", "-h", "localhost", "-u", "emol_db_user", "-pemol_db_password", "-e", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
networks:
  emol-network:
    driver: bridge

volumes:
  mysql_data:
  static:
  emol_logs:
  nginx_logs:
  nginx_run:
